name: Validate Scripts

on:
  push:
    branches: [main]
    paths:
      - '*.sh'
      - 'lib/*.sh'
      - 'templates/*.yaml'
      - 'Dockerfile'
      - 'fly.toml'
  pull_request:
    branches: [main]
    paths:
      - '*.sh'
      - 'lib/*.sh'
      - 'templates/*.yaml'
      - 'Dockerfile'
      - 'fly.toml'
  # Run weekly to catch issues with external dependencies
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9am UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate-scripts:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check bash syntax - all scripts
        run: |
          bash -n install.sh
          bash -n moltbot-cli.sh
          bash -n lib/common.sh
          bash -n lib/config.sh
          bash -n lib/provider-flyio.sh
          bash -n lib/provider-digitalocean.sh
          echo "✅ All shell scripts have valid syntax"

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: ShellCheck - all scripts
        run: |
          shellcheck -e SC2086,SC2034,SC1091 install.sh || true
          shellcheck -e SC2086,SC2034,SC1091 moltbot-cli.sh || true
          shellcheck -e SC2086,SC2034 lib/common.sh || true
          shellcheck -e SC2086,SC2034,SC1091 lib/config.sh || true
          shellcheck -e SC2086,SC2034,SC1091 lib/provider-flyio.sh || true
          shellcheck -e SC2086,SC2034,SC1091 lib/provider-digitalocean.sh || true

  validate-dockerfile:
    name: Validate Dockerfile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install hadolint
        run: |
          wget -q https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
          chmod +x hadolint-Linux-x86_64
          sudo mv hadolint-Linux-x86_64 /usr/local/bin/hadolint

      - name: Lint Dockerfile
        run: hadolint Dockerfile || true  # Warnings only

  test-install-dry-run:
    name: Test Install Script (Dry Run)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Test install.sh loads without errors
        run: |
          # Source the script to check for syntax errors in functions
          bash -n install.sh
          echo "✅ install.sh syntax valid"

      - name: Test library modules load correctly
        run: |
          # Test that library modules can be sourced
          source lib/common.sh
          source lib/config.sh
          echo "✅ Library modules load correctly"

  test-curl-install:
    name: Test curl | bash Pattern
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start local server
        run: |
          python3 -m http.server 8080 &
          sleep 2

      - name: Test install.sh download and syntax
        run: |
          curl -fsSL http://localhost:8080/install.sh -o /tmp/install.sh
          bash -n /tmp/install.sh
          echo "✅ Downloaded install.sh is valid"

      - name: Test moltbot-cli.sh download and syntax
        run: |
          curl -fsSL http://localhost:8080/moltbot-cli.sh -o /tmp/moltbot-cli.sh
          chmod +x /tmp/moltbot-cli.sh
          bash -n /tmp/moltbot-cli.sh
          echo "✅ Downloaded moltbot-cli.sh is valid"

      - name: Test library modules download
        run: |
          mkdir -p /tmp/lib
          curl -fsSL http://localhost:8080/lib/common.sh -o /tmp/lib/common.sh
          curl -fsSL http://localhost:8080/lib/config.sh -o /tmp/lib/config.sh
          curl -fsSL http://localhost:8080/lib/provider-flyio.sh -o /tmp/lib/provider-flyio.sh
          curl -fsSL http://localhost:8080/lib/provider-digitalocean.sh -o /tmp/lib/provider-digitalocean.sh
          bash -n /tmp/lib/common.sh
          bash -n /tmp/lib/config.sh
          bash -n /tmp/lib/provider-flyio.sh
          bash -n /tmp/lib/provider-digitalocean.sh
          echo "✅ Downloaded library modules are valid"

  validate-fly-toml:
    name: Validate fly.toml
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Validate fly.toml syntax
        run: |
          # Basic TOML validation
          python3 -c "import tomllib; tomllib.load(open('fly.toml', 'rb'))" && echo "✅ fly.toml is valid TOML"
